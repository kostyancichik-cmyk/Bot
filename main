import telebot
import random
from telebot import types
import time
import json
import os
import threading
import atexit

bot = telebot.TeleBot("8257595632:AAHmrxOUf7qeRXHnsC-uPYbkRA2Q7lYI2ow")

# –§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = 'user_data.json'
data_lock = threading.Lock()

def load_user_data():
    try:
        if os.path.exists(DATA_FILE):
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                return {int(k): v for k, v in data.items()}
    except (json.JSONDecodeError, FileNotFoundError, ValueError):
        print("–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π.")
    return {}

def save_user_data():
    try:
        with open(DATA_FILE, 'w', encoding='utf-8') as f:
            json.dump(user_data, f, ensure_ascii=False, indent=2)
        print(f"–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(user_data)}")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")

def auto_save():
    while True:
        time.sleep(60)
        with data_lock:
            save_user_data()

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
with data_lock:
    user_data = load_user_data()
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(user_data)}")

# –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
save_thread = threading.Thread(target=auto_save, daemon=True)
save_thread.start()

# ----- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã -----
main_markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
main_markup.add(
    types.KeyboardButton("üéÆ –ö–ª–∏–∫–µ—Ä"),
    types.KeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å"),
    types.KeyboardButton("üõí –ú–∞–≥–∞–∑–∏–Ω"),
    types.KeyboardButton("üèÜ –¢–æ–ø")
)

clicker_markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
clicker_markup.add(
    types.KeyboardButton("üñ±Ô∏è –ö–ª–∏–∫!"),
    types.KeyboardButton("üîô –ù–∞–∑–∞–¥")
)

# ----- –§—É–Ω–∫—Ü–∏—è —Ç–æ–ø–∞ -----
def send_top(chat_id):
    with data_lock:
        users = []
        for uid, data in user_data.items():
            balance = data.get('balance', 0)
            if data.get('username'):
                name = '@' + data['username']
            else:
                name = data.get('first_name', f'User{uid}')
            users.append((uid, balance, name))
    
    users.sort(key=lambda x: x[1], reverse=True)
    top = users[:10]
    
    if not top:
        bot.send_message(chat_id, "üèÜ –ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –±–∞–ª–∞–Ω—Å–æ–º.")
        return
    
    text = "üèÜ <b>–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –±–∞–ª–∞–Ω—Å—É:</b>\n\n"
    for i, (_, bal, name) in enumerate(top, 1):
        text += f"{i}. {name} ‚Äî {bal} –º–æ–Ω–µ—Ç\n"
    
    bot.send_message(chat_id, text, parse_mode='html')

# ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ -----
@bot.message_handler(commands=['start'])
def welcome(message):
    user_id = message.from_user.id
    with data_lock:
        if user_id not in user_data:
            user_data[user_id] = {
                'balance': 0,
                'per_click': 1,
                'double_cost': 1500,
                'username': message.from_user.username,
                'first_name': message.from_user.first_name,
                'last_name': message.from_user.last_name,
                'total_clicks': 0,
                'registered': time.strftime("%Y-%m-%d %H:%M:%S")
            }
            save_user_data()
    
    user = user_data[user_id]
    # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äì –¥–æ–±–∞–≤–∏–º double_cost, –µ—Å–ª–∏ –Ω–µ—Ç
    if 'double_cost' not in user:
        user['double_cost'] = 1500
        save_user_data()
    
    bot.send_message(
        message.chat.id,
        f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {message.from_user.first_name}!\n"
        f"üéÆ –≠—Ç–æ –∏–≥—Ä–∞-–∫–ª–∏–∫–µ—Ä!\n\n"
        f"üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç\n"
        f"‚ö° –ó–∞ –∫–ª–∏–∫: {user['per_click']} –º–æ–Ω–µ—Ç",
        parse_mode='html',
        reply_markup=main_markup
    )

@bot.message_handler(commands=['top'])
def top_command(message):
    send_top(message.chat.id)
    
@bot.message_handler(commands=['reset_balance'])
def reset_balance_command(message):
    # –ó–∞–º–µ–Ω–∏—Ç–µ 123456789 –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π Telegram ID
    if message.from_user.id != 5180925759:
        bot.reply_to(message, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return

    # –û–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç: /reset_balance <user_id>
    args = message.text.split()
    if len(args) != 2:
        bot.reply_to(message, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /reset_balance <id_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>")
        return

    try:
        target_id = int(args[1])
    except ValueError:
        bot.reply_to(message, "ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
        return

    with data_lock:
        if target_id in user_data:
            user_data[target_id]['balance'] = 0
            save_user_data()
            bot.reply_to(message, f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_id} –æ–±–Ω—É–ª—ë–Ω")
        else:
            bot.reply_to(message, f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {target_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")

@bot.message_handler(commands=['backup'])
def backup_command(message):
    # –ó–∞–º–µ–Ω–∏—Ç–µ 123456789 –Ω–∞ –≤–∞—à Telegram ID
    if message.from_user.id == 5180925759:
        with data_lock:
            backup_file = f"backup_{int(time.time())}.json"
            with open(backup_file, 'w', encoding='utf-8') as f:
                json.dump(user_data, f, ensure_ascii=False, indent=2)
        bot.send_message(
            message.chat.id,
            f"‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_file}\n"
            f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(user_data)}"
        )
    else:
        bot.send_message(message.chat.id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")

# ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ -----
@bot.message_handler(content_types=['text'])
def handle_text(message):
    user_id = message.from_user.id

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with data_lock:
        if user_id not in user_data:
            user_data[user_id] = {
                'balance': 0,
                'per_click': 1,
                'double_cost': 1500,          # <-- –¥–æ–±–∞–≤–∏–ª–∏
                'username': message.from_user.username,
                'first_name': message.from_user.first_name,
                'last_name': message.from_user.last_name,
                'total_clicks': 0,
                'registered': time.strftime("%Y-%m-%d %H:%M:%S")
            }
            save_user_data()
    
    user = user_data[user_id]
    # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äì –¥–æ–±–∞–≤–∏–º double_cost, –µ—Å–ª–∏ –Ω–µ—Ç
    if 'double_cost' not in user:
        user['double_cost'] = 1500
        save_user_data()

    if message.text == "üéÆ –ö–ª–∏–∫–µ—Ä":
        bot.send_message(
            message.chat.id,
            f"üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª–∏–∫–µ—Ä!\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç\n"
            f"‚ö° –ó–∞ –∫–ª–∏–∫: {user['per_click']} –º–æ–Ω–µ—Ç\n"
            f"üñ±Ô∏è –í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: {user.get('total_clicks', 0)}",
            reply_markup=clicker_markup
        )

    elif message.text == "üí∞ –ë–∞–ª–∞–Ω—Å":
        try:
            reg_time = time.mktime(time.strptime(user.get('registered', '2024-01-01'), "%Y-%m-%d %H:%M:%S"))
            hours_passed = max(1, (time.time() - reg_time) / 3600)
            clicks_per_hour = user.get('total_clicks', 0) / hours_passed
        except:
            clicks_per_hour = 0
        income_per_hour = clicks_per_hour * user['per_click']

        bot.send_message(
            message.chat.id,
            f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç\n"
            f"‚ö° –ó–∞ –∫–ª–∏–∫: {user['per_click']} –º–æ–Ω–µ—Ç\n"
            f"üñ±Ô∏è –í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: {user.get('total_clicks', 0)}\n"
            f"üìà –ü—Ä–∏–º–µ—Ä–Ω–æ –≤ —á–∞—Å: {income_per_hour:.1f} –º–æ–Ω–µ—Ç"
        )

    elif message.text == "üõí –ú–∞–≥–∞–∑–∏–Ω":
        shop_markup = types.InlineKeyboardMarkup(row_width=2)
        shop_markup.add(
            types.InlineKeyboardButton(
                text=f"–£–ª—É—á—à–∏—Ç—å –∫–ª–∏–∫ ({user['per_click'] * 100} –º–æ–Ω–µ—Ç)",
                callback_data="upgrade_click"
            ),
            types.InlineKeyboardButton(
                text=f"–£–¥–≤–æ–∏—Ç–µ–ª—å ({user['double_cost']} –º–æ–Ω–µ—Ç)",  # —Ç–µ–ø–µ—Ä—å –ø–æ–ª–µ —Ç–æ—á–Ω–æ –µ—Å—Ç—å
                callback_data="double_click"
            ),
            types.InlineKeyboardButton(
                text=f"–ë–æ–Ω—É—Å (1 —Ä–∞–∑ –≤ –¥–µ–Ω—å)",
                callback_data="daily_bonus"
            )
        )
        bot.send_message(
            message.chat.id,
            f"üõí –ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π:\nüí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç",
            reply_markup=shop_markup
        )

    elif message.text == "üñ±Ô∏è –ö–ª–∏–∫!":
        with data_lock:
            user['balance'] += user['per_click']
            user['total_clicks'] = user.get('total_clicks', 0) + 1
            save_user_data()

        if random.random() < 0.1:
            bonus = user['per_click'] * 2
            with data_lock:
                user['balance'] += bonus
                save_user_data()
            bot.send_message(
                message.chat.id,
                f"üéâ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ö–õ–ò–ö! +{bonus} –º–æ–Ω–µ—Ç!\nüí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç"
            )
        else:
            bot.send_message(
                message.chat.id,
                f"üñ±Ô∏è +{user['per_click']} –º–æ–Ω–µ—Ç!\nüí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç"
            )

    elif message.text == "üèÜ –¢–æ–ø":
        send_top(message.chat.id)

    elif message.text == "üîô –ù–∞–∑–∞–¥":
        bot.send_message(
            message.chat.id,
            "üîô –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            reply_markup=main_markup
        )

# ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ (–º–∞–≥–∞–∑–∏–Ω) -----
@bot.callback_query_handler(func=lambda call: True)
def callback_inline(call):
    user_id = call.from_user.id

    with data_lock:
        if user_id not in user_data:
            user_data[user_id] = {
                'balance': 0,
                'per_click': 1,
                'double_cost': 1500,          # <-- –¥–æ–±–∞–≤–∏–ª–∏
                'username': call.from_user.username,
                'first_name': call.from_user.first_name,
                'last_name': call.from_user.last_name,
                'total_clicks': 0,
                'registered': time.strftime("%Y-%m-%d %H:%M:%S"),
                'last_bonus': None
            }
            save_user_data()
        user = user_data[user_id]
        # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äì –¥–æ–±–∞–≤–∏–º double_cost, –µ—Å–ª–∏ –Ω–µ—Ç
        if 'double_cost' not in user:
            user['double_cost'] = 1500
            save_user_data()

    # ----- –£–ª—É—á—à–µ–Ω–∏–µ –∫–ª–∏–∫–∞ -----
    if call.data == "upgrade_click":
        cost = user['per_click'] * 100
        if user['balance'] >= cost:
            with data_lock:
                user['balance'] -= cost
                user['per_click'] += 1
                save_user_data()
            bot.answer_callback_query(call.id, f"‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å +{user['per_click']} –∑–∞ –∫–ª–∏–∫")
            bot.edit_message_text(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                text=f"üõí –ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π:\nüí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç",
                reply_markup=call.message.reply_markup
            )
        else:
            bot.answer_callback_query(call.id, f"‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç {cost - user['balance']} –º–æ–Ω–µ—Ç")

    # ----- –£–¥–≤–æ–∏—Ç–µ–ª—å -----
    elif call.data == "double_click":
        cost = user['double_cost']
        if user['balance'] >= cost:
            with data_lock:
                user['balance'] -= cost
                user['per_click'] *= 2
                user['double_cost'] *= 3
                save_user_data()
            bot.answer_callback_query(call.id, f"‚úÖ –£–¥–≤–æ–∏—Ç–µ–ª—å –∫—É–ø–ª–µ–Ω! –¢–µ–ø–µ—Ä—å +{user['per_click']} –∑–∞ –∫–ª–∏–∫")
            bot.edit_message_text(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                text=f"üõí –ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π:\nüí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç",
                reply_markup=call.message.reply_markup
            )
        else:
            bot.answer_callback_query(call.id, f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –ù—É–∂–Ω–æ {cost} –º–æ–Ω–µ—Ç")

    # ----- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å -----
    elif call.data == "daily_bonus":
        now = time.time()
        last = user.get('last_bonus')
        if last and (now - last) < 86400:
            hours = int((86400 - (now - last)) / 3600)
            bot.answer_callback_query(call.id, f"‚ùå –ë–æ–Ω—É—Å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å. –û—Å—Ç–∞–ª–æ—Å—å {hours} —á.")
        else:
            bonus = 100 + user['per_click'] * 10
            with data_lock:
                user['balance'] += bonus
                user['last_bonus'] = now
                save_user_data()
            bot.answer_callback_query(call.id, f"‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å: +{bonus} –º–æ–Ω–µ—Ç!")
            bot.edit_message_text(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                text=f"üõí –ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π:\nüí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {user['balance']} –º–æ–Ω–µ—Ç",
                reply_markup=call.message.reply_markup
            )

# ----- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ -----
def save_on_exit():
    print("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º...")
    with data_lock:
        save_user_data()

atexit.register(save_on_exit)

# ----- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ -----
if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    try:
        bot.polling(none_stop=True)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
    finally:
        with data_lock:
            save_user_data()
